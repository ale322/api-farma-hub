<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Consulta App</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .phone-frame { max-width: 400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; min-height: 600px; }
        .header { background-color: #007bff; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: bold; color: #007bff; font-size: 18px; }
        .btn-zap { display:inline-block; margin-top:5px; background:#25D366; color:white; padding:8px 12px; text-decoration:none; font-size:13px; border-radius:4px; font-weight:bold; cursor: pointer; }
        .btn-zap:hover { background-color: #1ebc57; }
        .badge { font-size: 10px; padding: 3px 6px; border-radius: 4px; color: white; background-color: #28a745; }
        .simulacao-msg { font-size: 11px; color: blue; text-align: center; margin-bottom: 10px; background: #e7f3ff; padding: 5px; display: none; }
        .btn-action { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 20px; }
        .error-msg { color: red; text-align: center; font-size: 12px; display: none; }
    </style>
</head>
<body>

    <div class="phone-frame">
        <div class="header">
            <h2>Dr. Consulta App</h2>
            <small>Monitoramento Ativo</small>
        </div>

        <div class="content">
            <div id="aviso-simulacao" class="simulacao-msg">‚ö†Ô∏è Modo Simula√ß√£o: Localiza√ß√£o Salvador.</div>
            <div id="erro-global" class="error-msg"></div>

            <button class="btn-action" onclick="iniciarBusca('789101010')">üíä Buscar Dipirona</button>
            <button class="btn-action" style="background-color: #6c757d;" onclick="iniciarBusca('789202020')">üíä Buscar Tylenol</button>
            
            <div id="resultados"><p style="text-align:center; color:#999;">Clique para buscar.</p></div>
        </div>
    </div>

    <script>
        const API_BASE = "https://api-farma-hub.onrender.com"; 

        function iniciarBusca(ean) {
            const divResultados = document.getElementById('resultados');
            divResultados.innerHTML = '<p style="text-align:center;">üîç Buscando...</p>';
            
            // Ativa aviso visual de simula√ß√£o
            document.getElementById('aviso-simulacao').style.display = 'block';
            
            // For√ßa coordenadas de Salvador (Barra) para teste
            fazerRequisicao(ean, -13.0101, -38.5323); 
        }

        async function fazerRequisicao(ean, lat, lon) {
            const divResultados = document.getElementById('resultados');
            try {
                const response = await fetch(`${API_BASE}/search?ean=${ean}&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                divResultados.innerHTML = '';

                if (data.length === 0) {
                    divResultados.innerHTML = '<p style="text-align:center;">‚ùå Nenhum estoque encontrado.</p>'; 
                    return;
                }

                data.forEach(item => {
                    // Prote√ß√£o: Se a API antiga n√£o mandar ID, usa 0
                    const safeId = item.id || 0; 
                    
                    const zapLink = `https://wa.me/5571999999999?text=Quero reservar o item ${ean}`;

                    // Cria o HTML do cart√£o
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <div>
                            <h3>${item.farmacia}</h3>
                            <p>${item.endereco}</p>
                            <span class="badge">Estoque: ${item.estoque}</span><br>
                            <small>üìç ${item.distancia_txt || '?? km'}</small>
                        </div>
                        <div style="text-align:right;">
                            <div class="price">${item.preco}</div>
                            <a href="${zapLink}" target="_blank" class="btn-zap" 
                               onclick="registrarClique(${safeId}, '${item.farmacia}', '${ean}')">
                               üì± Reservar
                            </a>
                        </div>
                    `;
                    divResultados.appendChild(div);
                });
            } catch (error) { 
                console.error(error);
                divResultados.innerHTML = '<p style="text-align:center; color:red;">Erro na conex√£o com a API.</p>'; 
            }
        }

        function registrarClique(idDinamico, nomeFarma, ean) {
            console.log(`Enviando lead: Farm√°cia ID ${idDinamico} (${nomeFarma})`);
            
            // Envia o dado para a nuvem
            fetch(`${API_BASE}/log_action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pharmacy_id: idDinamico, 
                    ean: ean,
                    action: "clique_whatsapp"
                })
            }).catch(err => console.error("Erro ao logar:", err));
        }
    </script>
</body>
</html>
