<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script>
        // Verifica se o usu√°rio tem o "crach√°" (Token)
        if (sessionStorage.getItem("farma_token_acesso") !== "autorizado") {
            // Se n√£o tiver, manda de volta pro Login
            window.location.href = "admin.html";
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel FarmaHub - Ao Vivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; margin: 0; padding: 20px; color: #1F2937; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Cabe√ßalho */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { font-size: 24px; font-weight: 800; color: #2563EB; display: flex; align-items: center; gap: 10px; }
        
        /* Indicador de Ao Vivo */
        .live-badge { 
            background: #DEF7EC; color: #03543F; padding: 6px 12px; border-radius: 20px; 
            font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: 1px solid #BCF0DA;
        }
        .live-dot { width: 8px; height: 8px; background: #0E9F6E; border-radius: 50%; animation: pulse 1.5s infinite; }

        /* Cart√µes */
        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        
        /* Destaque do N√∫mero */
        .stat-label { font-size: 14px; color: #6B7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .big-number { font-size: 64px; font-weight: 800; color: #111827; margin: 10px 0; transition: color 0.3s; }
        .big-number.updated { color: #059669; animation: bounce 0.5s; } /* Efeito quando muda */

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; color: #6B7280; font-size: 13px; font-weight: 600; border-bottom: 1px solid #E5E7EB; }
        td { padding: 16px 12px; border-bottom: 1px solid #F3F4F6; font-size: 14px; color: #374151; }
        tr:last-child td { border-bottom: none; }
        
        .badge-zap { 
            background: #DEF7EC; color: #03543F; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; 
            display: inline-flex; align-items: center; gap: 4px;
        }

        /* Anima√ß√µes */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="brand">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>
                FarmaHub Admin
            </div>
            <div class="live-badge">
                <span class="live-dot"></span> Ao Vivo
            </div>
        </div>

        <div class="grid">
            <div class="card" style="text-align: center;">
                <span class="stat-label">Leads Gerados (M√™s)</span>
                <div id="total-clientes" class="big-number">--</div>
                <small style="color: #6B7280;">Cliques no bot√£o "Reservar" direcionados para o WhatsApp</small>
            </div>

            <div class="card">
                <h2 style="font-size: 18px; margin: 0 0 10px 0; color: #111827;">üïµÔ∏è √öltimas Intera√ß√µes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>HOR√ÅRIO</th>
                            <th>FARM√ÅCIA</th>
                            <th>PRODUTO</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-logs">
                        <tr><td colspan="4" style="text-align:center; color:#999;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://api-farma-hub.onrender.com/dashboard";
        let ultimoTotal = 0; // Para saber se o n√∫mero mudou

        async function carregarDados() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                // 1. Calcula o Total
                let totalAtual = 0;
                for (let key in data.resumo_mensal) {
                    totalAtual += data.resumo_mensal[key];
                }

                // 2. Atualiza o N√∫mero na tela
                const divTotal = document.getElementById('total-clientes');
                divTotal.innerText = totalAtual;

                // SE O N√öMERO MUDOU: Faz um efeito visual (Flash Verde)
                if (totalAtual > ultimoTotal && ultimoTotal !== 0) {
                    divTotal.classList.add('updated');
                    setTimeout(() => divTotal.classList.remove('updated'), 1000); // Remove o efeito depois de 1s
                }
                ultimoTotal = totalAtual;

                // 3. Preenche a Tabela
                const tbody = document.getElementById('tabela-logs');
                tbody.innerHTML = "";
                
                // Pega s√≥ os 5 primeiros para n√£o ficar gigante
                data.auditoria_ultimos_cliques.slice(0, 5).forEach(linhaTexto => {
                    const dataHora = linhaTexto.substring(1, 20); // Pega a data [2025...]
                    
                    // Tratamento simples para separar nome e produto do texto bruto
                    // Formato esperado: "[DATA] Farmacia - EAN (clique)"
                    let textoLimpo = linhaTexto.substring(22).replace('(clique_whatsapp)', '');
                    let partes = textoLimpo.split(' - ');
                    let farmacia = partes[0] || "Desconhecida";
                    let produto = partes[1] || "Item";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-family:monospace; color:#6B7280;">${dataHora.split(' ')[1]}</td> <td style="font-weight:600;">${farmacia}</td>
                        <td>${produto}</td> 
                        <td><span class="badge-zap">Enviado ‚úÖ</span></td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Erro na atualiza√ß√£o:", error);
            }
        }

        // --- O SEGREDO DA AUTOMA√á√ÉO ---
        // 1. Carrega assim que abre
        carregarDados();
        
        // 2. Atualiza automaticamente a cada 5 segundos (5000ms)
        setInterval(carregarDados, 5000);
    </script>
</body>
</html>
